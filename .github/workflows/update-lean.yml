name: Update Lean Toolchain

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:

jobs:
  update-lean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check for updates
        id: check
        run: |
          current_version=$(cat lean-toolchain | awk -F: '{print $2}')
          echo "Current version: $current_version"
          
          # Get latest simple-version tag (e.g., v4.6.0) from leanprover/lean4
          latest_tag=$(curl -s "https://api.github.com/repos/leanprover/lean4/releases/latest" | jq -r .tag_name)
          latest_version=${latest_tag#v}
          echo "Latest version: $latest_version"
          
          if [ "$current_version" != "$latest_version" ]; then
            echo "New version available!"
            echo "leanprover/lean4:$latest_version" > lean-toolchain
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "version=$latest_version" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update lean toolchain to ${{ steps.check.outputs.version }}"
          title: "chore: update lean toolchain to ${{ steps.check.outputs.version }}"
          body: |
            Updates [leanprover/lean4](https://github.com/leanprover/lean4) to version `${{ steps.check.outputs.version }}`.
            
            Auto-generated by GitHub Actions.
          branch: update-lean-toolchain
          base: main
          delete-branch: true
