name: Update Dependencies

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lean-toolchain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for Lean toolchain updates
        id: check
        run: |
          current_version=$(cat lean-toolchain | awk -F: '{print $2}')
          echo "Current version: $current_version"

          # Get latest simple-version tag (e.g., v4.6.0) from leanprover/lean4
          latest_tag=$(curl -s "https://api.github.com/repos/leanprover/lean4/releases/latest" | jq -r .tag_name)
          latest_version=${latest_tag#v}
          echo "Latest version: $latest_version"

          if [ "$current_version" != "$latest_version" ]; then
            echo "New version available!"
            echo "leanprover/lean4:$latest_version" > lean-toolchain
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "version=$latest_version" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update lean toolchain to ${{ steps.check.outputs.version }}"
          title: "chore: update lean toolchain to ${{ steps.check.outputs.version }}"
          body: |
            Updates [leanprover/lean4](https://github.com/leanprover/lean4) to version `${{ steps.check.outputs.version }}`.

            Auto-generated by GitHub Actions.
          branch: update-lean-toolchain
          base: main
          delete-branch: true

  update-lake-dependencies:
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Chez Scheme
        run: sudo apt-get update && sudo apt-get install -y chezscheme

      - name: Setup Lean
        uses: leanprover/lean-action@v1
        with:
          build: false

      - name: Check for dependency updates
        id: update
        run: |
          # Save current manifest hash
          OLD_HASH=$(sha256sum lake-manifest.json | cut -d' ' -f1)

          # Run lake update
          lake update

          # Check if manifest changed
          NEW_HASH=$(sha256sum lake-manifest.json | cut -d' ' -f1)

          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Dependencies updated!"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available."
          fi

      - name: Build and test with updated dependencies
        if: steps.update.outputs.has_updates == 'true'
        run: |
          lake build
          lake test

      - name: Create Pull Request
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update Lake dependencies"
          title: "chore(deps): update Lake dependencies"
          body: |
            This PR updates Lake dependencies to their latest versions.

            Generated by the Update Dependencies workflow.
          branch: deps/lake-update
          delete-branch: true
          labels: dependencies
