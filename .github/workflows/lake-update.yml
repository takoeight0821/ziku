name: Lake Dependency Update

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-slim

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Lean
        uses: leanprover/lean-action@v1
        with:
          build: false

      - name: Check for dependency updates
        id: update
        run: |
          # Save current manifest hash
          OLD_HASH=$(sha256sum lake-manifest.json | cut -d' ' -f1)

          # Run lake update
          lake update

          # Check if manifest changed
          NEW_HASH=$(sha256sum lake-manifest.json | cut -d' ' -f1)

          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Dependencies updated!"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available."
          fi

      - name: Build and test with updated dependencies
        if: steps.update.outputs.has_updates == 'true'
        run: |
          lake build
          lake test

      - name: Create Pull Request
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update Lake dependencies"
          title: "chore(deps): update Lake dependencies"
          body: |
            This PR updates Lake dependencies to their latest versions.

            Generated by the Lake Dependency Update workflow.
          branch: deps/lake-update
          delete-branch: true
          labels: dependencies
