-- MAL Step 4: Functions and Control Flow - Natives Test
-- Implements: MNative and printer

-- ============================================ 
-- String helpers
-- ============================================ 

let rec strEqFrom = \s1 s2 i =>
  if i >= strLen s1 then true
  else
    let c1 = runeToInt (strAt s1 i) in
    let c2 = runeToInt (strAt s2 i) in
    if c1 == c2 then strEqFrom s1 s2 (i + 1)
    else false
in

let strEq = \s1 s2 =>
  if strLen s1 == strLen s2 then strEqFrom s1 s2 0
  else false
in

-- ============================================ 
-- Printer
-- ============================================ 

let rec prListContents = \pr h t =>
  let hStr = pr h in
  match t {
  | MNil => hStr
  | Cons(h2, t2) => hStr ++ " " ++ prListContents pr h2 t2
  | _ => hStr ++ " . " ++ pr t
  }
in

let rec prStr = \val =>
  match val {
  | MNum(n) => intToStr n
  | MSym(s) => s
  | MStr(s) => "\"" ++ s ++ "\""
  | MNil => "nil"
  | MTrue => "true"
  | MFalse => "false"
  | MErr(msg) => "Error: " ++ msg
  | Cons(h, t) => "(" ++ prListContents prStr h t ++ ")"
  | Pair(v, _) => prStr v
  | MNative(name) => "#<function>"
  }
in

-- ============================================ 
-- Environment
-- ============================================ 

let emptyEnv = Cons(MNil, MNil)
in

let rec lookupBindings = \bindings sym =>
  match bindings {
  | MNil => MNil
  | Cons(binding, rest) =>
    match binding {
    | Cons(MStr(name), val) =>
      if strEq name sym then Cons(MTrue, val)
      else lookupBindings rest sym
    | _ => lookupBindings rest sym
    }
  | _ => MNil
  }
in

let rec envGet = \env sym =>
  match env {
  | Cons(bindings, outer) =>
    match lookupBindings bindings sym {
    | Cons(MTrue, val) => val
    | _ =>
      match outer {
      | Cons(_, _) => envGet outer sym
      | _ => MErr("'" ++ sym ++ "' not found")
      }
    }
  | _ => MErr("invalid env")
  }
in

let envSet = \env sym val =>
  match env {
  | Cons(bindings, outer) =>
    Cons(Cons(Cons(MStr(sym), val), bindings), outer)
  | _ => Cons(Cons(Cons(MStr(sym), val), MNil), MNil)
  }
in

let replEnv = 
  let e0 = emptyEnv in
  let e1 = envSet e0 "+" (MNative("+")) in
  let e2 = envSet e1 "-" (MNative("-")) in
  let e3 = envSet e2 "*" (MNative("*")) in
  let e4 = envSet e3 "/" (MNative("/")) in
  let e5 = envSet e4 "list" (MNative("list")) in
  let e6 = envSet e5 "count" (MNative("count")) in
  envSet e6 "empty?" (MNative("empty?"))
in

-- ============================================ 
-- Test
-- ============================================ 

prStr (envGet replEnv "+")
